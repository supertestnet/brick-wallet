<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <title>Brick Wallet</title>
    <link rel="shortcut icon" type="image/x-icon" href="https://supertestnet.github.io/brick-wallet/favicon.ico">
    <script src="https://cdn.jsdelivr.net/gh/mebjas/html5-qrcode@master/minified/html5-qrcode.min.js"></script>
    <script src="https://supertestnet.github.io/bitcoin-chess/js/qrcode.js"></script>
    <script src="https://supertestnet.github.io/bitcoin-chess/js/bolt11.js"></script>
    <script src="https://supertestnet.github.io/nwcjs/nwcjs.js"></script>
    <script src="https://bundle.run/browserify-cipher@1.0.1"></script>
    <script src="https://bundle.run/noble-secp256k1@1.2.14"></script>
    <script src="https://bundle.run/bech32@2.0.0"></script>
    <script>
        var modalVanish = () => {
            $( ".black-bg" ).classList.add( "hidden" );
            $( ".modal" ).classList.add( "hidden" );
        }
        var showModal = ( content, block_til_clear ) => {
            if ( block_til_clear ) var fn = `modalVanish();sessionStorage[ 'modal_cleared' ] = true;`; else var fn = `modalVanish();`;
            $( ".modal" ).innerHTML = `<div class="x_modal" style="position: absolute;right: 1rem;top: 0.5rem;font-size: 2rem; cursor: pointer; color: black;" onclick="${fn}">&times;</div>`;
            $( ".modal" ).innerHTML += `<div style="overflow-y: auto; max-height: 80vh; margin-top: 1.5rem;">${content}</div>`;
            $( ".black-bg" ).classList.remove( "hidden" );
            $( ".modal" ).classList.remove( "hidden" );
        }
        var showToast = content => {
            $( '.toast' ).innerHTML = content;
            $( '.toast' ).classList.add( "show" );
            setTimeout( () => $( '.toast' ).classList.remove( "show" ), 3000 );
        }
        var createQR = content => {
            var dataUriPngImage = document.createElement( "img" ),
            s = QRCode.generatePNG( content, {
                ecclevel: "M",
                format: "html",
                fillcolor: "#FFFFFF",
                textcolor: "#000000",
                margin: 4,
                modulesize: 8,
            });
            dataUriPngImage.src = s;
            dataUriPngImage.className = "qr_code";
            dataUriPngImage.style.width = "100%";
            return dataUriPngImage;
        }
        sessionStorage.removeItem( "lnurlp_amnt" );
        sessionStorage.removeItem( "lnurlw_amnt" );
        sessionStorage.removeItem( "ln_addy" );
        sessionStorage.removeItem( "ln_addy_amnt" );
        sessionStorage.removeItem( "yes_send" );
        sessionStorage.removeItem( "ln_invoice" );
        sessionStorage.removeItem( "nwc_string" );
        sessionStorage.removeItem( "modal_cleared" );
        async function getNote( item ) {
            async function isNoteSetYet( note_i_seek ) {
                return new Promise( function( resolve, reject ) {
                    if ( !note_i_seek ) {
                        setTimeout( async function() {
                            var msg = await isNoteSetYet( sessionStorage[ item ] );
                            resolve( msg );
                        }, 100 );
                    } else {
                        resolve( note_i_seek );
                    }
                });
            }
            async function getTimeoutData() {
                var note_i_seek = await isNoteSetYet( sessionStorage[ item ] );
                return note_i_seek;
            }
            var returnable = await getTimeoutData();
            return returnable;
        }
        var handleLNURLdata = async data => {
            var tag = data[ "tag" ];
            if ( tag === "payRequest" ) {
                var min = Math.floor( data[ "minSendable" ] / 1000 );
                var max = Math.floor( data[ "maxSendable" ] / 1000 );
                if ( isNaN( min ) || isNaN( max ) ) return alert( `the lnurl was invalid, try again` );
                if ( !Number( min ) || !Number( max ) ) return alert( `the lnurl was invalid, try again` );
                balance.calculateBalance();
                var sum = Number( $( '.balance span' ).getAttribute( "data-sats_sum" ) );
                var html = `
                    <p>Enter an amount to send</p>
                    <p>Min: ${min.toLocaleString()} sats | Max: ${Math.min( max, sum ).toLocaleString()} sats</p>
                    <p><input class="lnurlp_amnt"></p>
                    <p><button class="submit_lnurlp_form" onclick="sessionStorage[ 'lnurlp_amnt' ] = $( '.lnurlp_amnt' ).value;sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Submit</button></p>
                `;
                sessionStorage.removeItem( "lnurlp_amnt" );
                sessionStorage.removeItem( "modal_cleared" );
                var block_til_clear = true;
                showModal( html, block_til_clear );
                await getNote( "modal_cleared" );
                sessionStorage.removeItem( "modal_cleared" );
                var amount = Number( sessionStorage[ "lnurlp_amnt" ] ) * 1000;
                sessionStorage.removeItem( "lnurlp_amnt" );
                if ( !amount ) return;
                showModal( `<p>sending...</p>` );
                var callback = data[ "callback" ] + "?amount=" + amount;
                var invoice_data = await fetch( callback );
                var {pr: invoice} = await invoice_data.json();
                var skip_conf = true;
                send( invoice, skip_conf );
                showPage( 'wallet_body' );
            }
            if ( tag === "withdrawRequest" ) {
                var min = Math.floor( data[ "minWithdrawable" ] / 1000 );
                var max = Math.floor( data[ "maxWithdrawable" ] / 1000 );
                if ( isNaN( min ) || isNaN( max ) ) return alert( `the lnurl was invalid, try again` );
                if ( !Number( min ) || !Number( max ) ) return alert( `the lnurl was invalid, try again` );
                var html = `
                    <p>Enter an amount to withdraw</p>
                    <p>Min: ${min.toLocaleString()} sats | Max: ${max.toLocaleString()} sats</p>
                    <p><input class="lnurlw_amnt"></p>
                    <p><button class="submit_lnurlw_form" onclick="sessionStorage[ 'lnurlw_amnt' ] = $( '.lnurlw_amnt' ).value;sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Submit</button></p>
                `;
                sessionStorage.removeItem( "lnurlw_amnt" );
                sessionStorage.removeItem( "modal_cleared" );
                var block_til_clear = true;
                showModal( html, block_til_clear );
                await getNote( "modal_cleared" );
                sessionStorage.removeItem( "modal_cleared" );
                var amnt = Number( sessionStorage[ "lnurlw_amnt" ] );
                sessionStorage.removeItem( "lnurlw_amnt" );
                if ( !amnt ) return;
                showModal( `<p>processing...</p>` );
                var desc = "NWC Wallet";
                var delay_tolerance = 10;
                var invoice_info = await nwcjs.makeInvoice( brick_wallet.state.nwc_info, amnt, desc, delay_tolerance );
                if ( "result_type" in invoice_info && invoice_info[ "result_type" ] !== "make_invoice" ) return alert( `your wallet encountered an undefined error while processing this withdraw code, try again` );
                if ( "error" in invoice_info && invoice_info[ "error" ] ) return alert( `error processing your withdraw code: ${JSON.stringify( invoice_info[ "error" ] )} -- please try again` );
                var invoice = invoice_info.result.invoice;
                $( '.invoice_box' ).innerText = invoice;
                var loop = async () => {
                    await brick_wallet.waitSomeTime( 3000 );
                    var delay_tolerance = 10;
                    var status_info = await nwcjs.checkInvoice( brick_wallet.state.nwc_info, invoice, delay_tolerance );
                    if ( "error" in status_info && status_info[ "error" ] ) return alert( `error checking the status of your withdrawal: ${JSON.stringify( status_info[ "error" ] )} -- please refresh your page` );
                    if ( !status_info.result.settled_at ) return loop();
                    var new_tx = status_info[ "result" ];
                    if ( new_tx[ "invoice" ] ) var payment_hash = brick_wallet.getInvoicePmthash( new_tx[ "invoice" ] );
                    else var payment_hash = brick_wallet.getInvoicePmthash( new_tx[ "bolt11" ] );
                    var new_txs = {}
                    new_tx[ "detail_hidden" ] = true;
                    new_tx[ "payment_hash" ] = payment_hash;
                    new_txs[ new_tx[ "payment_hash" ] ] = new_tx;
                    brick_wallet.state.history = { ...new_txs, ...brick_wallet.state.history };
                    brick_wallet.parseHistory();
                    balance.calculateBalance();
                    if ( !$( '.modal' ).classList.contains( "hidden" ) ) {
                        showModal( "<p>success</p>" );
                        await brick_wallet.waitSomeTime( 1000 );
                        if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                    }
                    brick_wallet.parseHistory();
                    balance.calculateBalance();
                    showPage( 'wallet_body' );
                    return true;
                }
                loop();
                var callback = data[ "callback" ] + "?pr=" + invoice + "&k1=" + data[ "k1" ];
                var withdraw_data = await fetch( callback );
                try {
                    var {status: success} = await withdraw_data.json();
                    if ( !success || success !== "OK" ) alert( `There was an unknown problem processing your withdrawal, please try again` );
                } catch ( e ) {
                    alert( `There was an unknown problem processing your withdrawal, please try again` );
                }
            }
        }
        var getData = url => {
            return new Promise( async function( resolve, reject ) {
                function inner_get( url ) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.open( "GET", url, true );
                    xhttp.send();
                    return xhttp;
                }
                var data = inner_get( url );
                data.onerror = function( e ) {
                    resolve( "error" );
                }
                async function isResponseReady() {
                    return new Promise( function( resolve2, reject ) {
                        if ( !data.responseText || data.readyState != 4 ) {
                            setTimeout( async function() {
                                var msg = await isResponseReady();
                                resolve2( msg );
                            }, 1 );
                        } else {
                            resolve2( data.responseText );
                        }
                    });
                }
                var returnable = await isResponseReady();
                resolve( returnable );
            });
        }

        var getBitcoinPriceFromCoinbase = async () => {
            var data = await getData( "https://api.coinbase.com/v2/prices/BTC-USD/spot" );
            if ( data == "error" ) return 0;
            var json = JSON.parse( data );
            var price = json[ "data" ][ "amount" ];
            return price;
        }

        var getBitcoinPriceFromKraken = async () => {
            var data = await getData( "https://api.kraken.com/0/public/Ticker?pair=XBTUSD" );
            if ( data == "error" ) return 0;
            var json = JSON.parse( data );
            var price = json[ "result" ][ "XXBTZUSD" ][ "a" ][ 0 ];
            return price;
        }

        var getBitcoinPriceFromCoindesk = async () => {
            var data = await getData( "https://api.coindesk.com/v1/bpi/currentprice.json" );
            if ( data == "error" ) return 0;
            var json = JSON.parse( data );
            var price = json[ "bpi" ][ "USD" ][ "rate_float" ];
            return price;
        }

        var getBitcoinPriceFromGemini = async () => {
            var data = await getData( "https://api.gemini.com/v2/ticker/BTCUSD" );
            if ( data == "error" ) return 0;
            var json = JSON.parse( data );
            var price = json[ "bid" ];
            return price;
        }

        var getBitcoinPriceFromCoinGecko = async () => {
            var data = await getData( "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&precision=2" );
            if ( data == "error" ) return 0;
            var json = JSON.parse( data );
            var price = json[ "bitcoin" ][ "usd" ];
            return price;
        }

        var getBitcoinPrice = async () => {
            var prices = [];
            var cbprice = await getBitcoinPriceFromCoinbase();
            var kprice = await getBitcoinPriceFromKraken();
            var cdprice = await getBitcoinPriceFromCoindesk();
            var gprice = await getBitcoinPriceFromGemini();
            var cgprice = await getBitcoinPriceFromCoinGecko();
            prices.push( Number( cbprice ), Number( kprice ), Number( cdprice ), Number( gprice ), Number( cgprice ) );
            prices.sort();
            return prices[ 2 ];
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            font-size: 1.15rem;
            font-family: Arial, sans-serif;
        }
        html {
            max-width: 800px;
            padding: 3rem 1rem;
            margin: auto;
            line-height: 1.25;
            padding: 0;
        }
        body {
            margin: 3rem 1rem;
        }
        h1 {
            font-size: 2rem;
        }
        h2 {
            font-size: 1.5rem;
        }
        input {
            line-height: 1.25;
            width: 100%;
            height: 1.8rem;
            font-size: 1.15rem;
            border: 1px solid grey;
        }
        .hidden {
            display: none !important;
        }
        .balance span {
            cursor: pointer;
        }
        .wallet_body, .send_page, .receive_page {
            max-width: 15rem;
            margin: auto;
            word-wrap: break-word;
        }
        .send_page, .receive_page {
            max-width: 30rem;
        }
        button {
            background-color: #77a8fc;
            color: white !important;
            font-weight: bold;
            padding: .2rem;
            width: 7rem;
            font-size: 80%;
        }
        .hist_btn {
            width: 2rem;
        }
        .hist_btn:disabled {
            background-color: #cccccc;
        }
        .wallet_btns, .send_scanner_btns, .receive_scanner_btns {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
        }
        .send_scanner_btns button, .receive_scanner_btns button {
            margin: .5rem;
        }
        .invoice_box {
            margin-top: 1rem;
            border: 1px solid black;
            color: black;
            font-family: monospace;
            padding: 0.5rem;
            max-width: 15rem;
        }
        .hist_btns {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        .noselect {
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old versions of Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently
            supported by Chrome, Edge, Opera and Firefox */
        }
        .arrow {
            display: flex;
            padding: .5rem;
            border-radius: 50%;
            width: 2rem;
            height: 2rem;
            justify-content: center;
            align-items: center;
        }
        .arrow.incoming_arrow {
            border: 1px solid #52b354;
        }
        .arrow.outgoing_arrow {
            border: 1px solid #77a8fc;
        }
        .history > :first-child {
            border-top: 1px solid black;
        }
        .clickable_tx_parent {
            border-bottom: 1px solid black;
        }
        .incoming_tx, .outgoing_tx {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: .5rem;
            padding-top: .5rem;
            cursor: pointer;
        }
        .incoming_tx {
            color: #52b354;
        }
        .outgoing_tx {
            color: #77a8fc;
        }
        .hidable_tx_data {
            background-color: #cccccc;
            padding: .5rem;
            margin-bottom: .5rem;
        }
        .tx_detail {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: .5rem 0;
        }
        .tx_detail_big {
            margin: .5rem 0;
        }
        .disconnect {
            margin: 1rem 0rem;
            width: 100%;
        }
        .supported_currencies button,
        .selected_currencies button {
            margin: .5rem;
        }
        .black-bg {
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background-color: black;
            opacity: .5;
            width: 100vw;
            height: 100vh;
        }
        .modal {
            position: fixed;
            box-sizing: border-box;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            width: 90%;
            max-width: 560px;
            background-color: white;
            border-radius: 1rem;
            padding: 20px;
            color: black;
            text-align: center;
            word-wrap: break-word;
        }
        .modal * {
            color: black;
        }
        .modal input, .modal textarea {
            max-width: 90%;
        }
        .copy_box {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 2.2rem;
        }
        .copy_addy {
            width: 100%;
            max-width: 78%;
            word-wrap: break-word;
            background-color: #cccccc;
            border: 1px solid black;
            padding: .3rem;
            height: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: block;
        }
        .copy_btn {
            width: 100%;
            max-width: 18%;
            text-align: center;
            background-color: #cccccc;
            border: 1px solid black;
            padding: .3rem;
            height: 100%;
            padding-top: 3%;
            cursor: pointer;
        }
        .toast {
            box-sizing: border-box;
            visibility: hidden;
            width: 250px;
            margin-left: -125px;
            background-color: rgb(97, 235, 52);
            color: white;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
        }

        .toast.show {
            visibility: visible;
            -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @-webkit-keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @keyframes fadein {
            from {bottom: 0; opacity: 0;}
            to {bottom: 30px; opacity: 1;}
        }

        @-webkit-keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }

        @keyframes fadeout {
            from {bottom: 30px; opacity: 1;}
            to {bottom: 0; opacity: 0;}
        }
        @media screen and (max-width: 600px) {
        }
    </style>
    <script>
        var $ = document.querySelector.bind( document );
        var $$ = document.querySelectorAll.bind( document );
        var url_params = new URLSearchParams( window.location.search );
        var url_keys = url_params.keys();
        var $_GET = {}
        for ( var key of url_keys ) $_GET[ key ] = url_params.get( key );
</script>
</head>
<body>
    <div class="send_page hidden">
        <div id="send_scanner"></div>
        <p class="send_scanner_btns"><button class="paste_invoice">Paste invoice</button><button class="cancel_send_scanner">Cancel</button><button class="close_send_scanner">Close scanner</button><button class="open_send_scanner hidden">Open scanner</button><button class="enter_ln_address">Enter LN address</button></p>
    </div>
    <div class="receive_page hidden">
        <div id="receive_scanner"></div>
        <div class="receive_form">
            <p>Enter the amount you want to receive or paste an lnurl withdraw code</p>
            <p><input class="receive_amnt"></p>
        </div>
        <p class="receive_scanner_btns"><button class="submit_receive_form">Submit</button><button class="cancel_receive">Cancel</button><button class="close_receive_scanner hidden">Close scanner</button><button class="open_receive_scanner">Open scanner</button></p>
    </div>
    <div class="wallet_body">
        <center><p class="balance" style="font-weight: bold;">loading balance...</p></center></h1>
        <div class="wallet_btns">
            <button class="send">Send</button>
            <button class="receive">Receive</button>
        </div>
        <center><div class="invoice_box hidden"></div></center>
        <!-- <center><p style="font-weight: bold;">History</p></center> -->
        <br>
        <center><div class="hist_btns hidden"><button class="hist_btn hist_back"><</button><button class="hist_btn hist_fwd">></button></div></center>
        <center><div class="history">loading history...</div></center>
        <center><button class="disconnect">Disconnect wallet</button></center>
    </div>
    <script>
        var stop_the_save;
        var brick_wallet = {
            state: {
                nwc_string: null,
                nwc_info: null,
                last_tx: 1,
                offset: 0,
                history: [],
                selected_currencies: [],
                supported_currencies: [],
            },
            loaded: false,
            waitSomeTime: async milliseconds => new Promise( resolve => setTimeout( resolve, milliseconds ) ),
            getInvoicePmthash: invoice => {
                var decoded = bolt11.decode( invoice );
                var i; for ( i=0; i<decoded[ "tags" ].length; i++ ) {
                    if ( decoded[ "tags" ][ i ][ "tagName" ] == "payment_hash" ) var pmthash = decoded[ "tags" ][ i ][ "data" ].toString();
                }
                return pmthash;
            },
            hexToText: hex => {
                var bytes = new Uint8Array( Math.ceil( hex.length / 2 ) );
                for ( var i = 0; i < hex.length; i++ ) bytes[ i ] = parseInt( hex.substr( i * 2, 2 ), 16 );
                var text = new TextDecoder().decode( bytes );
                return text;
            },
            init: async () => {
                if ( brick_wallet.loaded ) await brick_wallet.waitSomeTime( 3000 );
                if ( Object.keys( brick_wallet.state.history ).length ) {
                    if ( !brick_wallet.loaded ) brick_wallet.parseHistory();
                } else {
                    if ( brick_wallet.loaded ) $( '.history' ).innerText = 'No history';
                }
                brick_wallet.loaded = true;
                if ( !brick_wallet.state.nwc_string ) {
                    localStorage.clear();
                    var html = `
                        <p>Please enter an NWC string with full permissions</p>
                        <p><input class="nwc_string_form"></p>
                        <p><button class="submit_nwc_string_form" onclick="sessionStorage[ 'nwc_string' ] = $( '.nwc_string_form' ).value;sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Submit</button></p>
                    `;
                    sessionStorage.removeItem( "nwc_string" );
                    sessionStorage.removeItem( "modal_cleared" );
                    var block_til_clear = true;
                    showModal( html, block_til_clear );
                    await getNote( "modal_cleared" );
                    sessionStorage.removeItem( "modal_cleared" );
                    brick_wallet.state.nwc_string = sessionStorage[ "nwc_string" ];
                    sessionStorage.removeItem( "nwc_string" );
                    // brick_wallet.state.nwc_string = prompt( `please enter an NWC string with full permissions` );
                }
                if ( !brick_wallet.state.nwc_string ) return;
                brick_wallet.state.nwc_info = nwcjs.processNWCstring( brick_wallet.state.nwc_string );
                balance.calculateBalance();
                var from = brick_wallet.state.last_tx;
                var delay_tolerance = 10;
                var txs = await nwcjs.listTransactions( brick_wallet.state.nwc_info, from, null, null, null, null, null, delay_tolerance );
                if ( txs && txs.result && txs.result.transactions && txs.result.transactions.length ) {
                    var new_txs = {}
                    txs.result.transactions.forEach( new_tx => {
                        new_tx[ "detail_hidden" ] = true;
                        new_txs[ new_tx[ "payment_hash" ] ] = new_tx;
                    });
                    brick_wallet.state.history = { ...new_txs, ...brick_wallet.state.history };
                    brick_wallet.state.last_tx = txs.result.transactions[ 0 ].created_at + 1;
                    brick_wallet.parseHistory();
                    balance.calculateBalance();
                }
                brick_wallet.init();
            },
            parseHistory: () => {
                var history = [];
                Object.keys( brick_wallet.state.history ).forEach( txid => history.push( brick_wallet.state.history[ txid ] ) );
                history.sort( ( a, b ) => b[ "settled_at" ] - a[ "settled_at" ] );
                var remove_before = brick_wallet.state.offset * 5;
                history.splice( 0, remove_before );
                history.length = 5;
                var html = ``;
                if ( history.length ) {
                    $( '.hist_btns' ).classList.remove( "hidden" );
                    var len_of_hist = Object.keys( brick_wallet.state.history ).length;
                    if ( ( brick_wallet.state.offset + 1 ) * 5 >= len_of_hist ) $( '.hist_fwd' ).disabled = true;
                    else $( '.hist_fwd' ).disabled = false;
                    if ( !brick_wallet.state.offset ) $( '.hist_back' ).disabled = true;
                    else $( '.hist_back' ).disabled = false;
                    if ( brick_wallet.state.offset < 0 ) brick_wallet.state.offset = 0;
                    $( '.hist_fwd' ).onclick = () => {
                        if ( $( '.hist_fwd' ).disabled ) return;
                        var len_of_hist = Object.keys( brick_wallet.state.history ).length;
                        if ( ( brick_wallet.state.offset + 2 ) * 5 >= len_of_hist ) $( '.hist_fwd' ).disabled = true;
                        $( '.hist_back' ).disabled = false;
                        brick_wallet.state.offset = brick_wallet.state.offset + 1;
                        brick_wallet.parseHistory();
                        balance.calculateBalance();
                    }
                    $( '.hist_back' ).onclick = () => {
                        if ( $( '.hist_back' ).disabled ) return;
                        $( '.hist_fwd' ).disabled = false;
                        brick_wallet.state.offset = brick_wallet.state.offset - 1;
                        if ( brick_wallet.state.offset < 0 ) brick_wallet.state.offset = 0;
                        if ( !brick_wallet.state.offset ) $( '.hist_back' ).disabled = true;
                        brick_wallet.parseHistory();
                        balance.calculateBalance();
                    }
                }
                history.forEach( tx => {
                    if ( !tx ) return;
                    var txid = tx[ "payment_hash" ];
                    var invoice;
                    if ( "invoice" in tx ) invoice = tx[ "invoice" ];
                    if ( "bolt11" in tx ) invoice = tx[ "bolt11" ];
                    if ( $( '.invoice_box' ) && $( '.invoice_box' ).innerText === invoice ) {
                        if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                        $( '.invoice_box' ).innerText = "";
                    }
                    var arrow = `<span class="noselect arrow incoming_arrow">&#8601;</span>`;
                    var incoming_or_outgoing = "incoming_tx";
                    if ( tx[ "type" ] === "outgoing" ) {
                        arrow = `<span class="noselect arrow outgoing_arrow">&#8599;</span>`;
                        incoming_or_outgoing = "outgoing_tx";
                    }
                    var desc_div = `
                        <div class="tx_detail_big">
                            <p style="font-weight: bold;">Description</p>
                            <p class="desc_div"></p>
                        </div>
                    `;
                    var pmthash_div = "";
                    if ( "payment_hash" in tx && tx[ "payment_hash" ] ) pmthash_div = `
                        <div class="tx_detail_big">
                            <p style="font-weight: bold;">Payment hash</p>
                            <p>${tx[ "payment_hash" ]}</p>
                        </div>
                    `;
                    var invoice_div = "";
                    if ( "invoice" in tx && tx[ "invoice" ] ) invoice_div = `
                        <div class="tx_detail_big">
                            <p style="font-weight: bold;">Invoice</p>
                            <p>${tx[ "invoice" ]}</p>
                        </div>
                    `;
                    if ( "bolt11" in tx && tx[ "bolt11" ] ) invoice_div = `
                        <div class="tx_detail_big">
                            <p style="font-weight: bold;">Invoice</p>
                            <p>${tx[ "bolt11" ]}</p>
                        </div>
                    `;
                    var preimage_div = "";
                    if ( "preimage" in tx && tx[ "preimage" ] ) preimage_div = `
                        <div class="tx_detail_big">
                            <p style="font-weight: bold;">Preimage</p>
                            <p>${tx[ "preimage" ]}</p>
                        </div>
                    `;
                    var hidden_or_shown = tx[ "detail_hidden" ] ? "hidden" : "";
                    var txdata = `
                        <div class="clickable_tx_parent" data-txid="${txid}">
                            <div class="clickable_tx ${incoming_or_outgoing}">
                                ${arrow}
                                <span class="noselect tx_amt" data-sats="${Math.floor( ( tx[ "amount" ] + tx[ "fees_paid" ] ) / 1000 )}">${Math.floor( ( tx[ "amount" ] + tx[ "fees_paid" ] ) / 1000 )} sats</span>
                            </div>
                            <div class="hidable_tx_data ${hidden_or_shown}">
                                <div class="tx_detail">
                                    <span>Amount</span><span>${Math.floor( tx[ "amount" ] / 1000 )} sats</span>
                                </div>
                                <div class="tx_detail">
                                    <span>Fees</span><span>${Math.floor( tx[ "fees_paid" ] / 1000 )} sats</span>
                                </div>
                                <div class="tx_detail">
                                    <span>Time</span><div>${new Date( tx[ "settled_at" ] * 1000 ).toLocaleDateString( "en-CA" ) + "<br>" + new Date( tx[ "settled_at" ] * 1000 ).toLocaleTimeString()}</div>
                                </div>
                                ${desc_div}
                                ${pmthash_div}
                                ${preimage_div}
                                ${invoice_div}
                            </div>
                        </div>
                    `;
                    html = html + txdata;
                });
                var div = document.createElement( "div" );
                div.innerHTML = html;
                history.forEach( ( tx, index ) => {
                    if ( !tx ) return;
                    div.getElementsByClassName( "desc_div" )[ index ].innerText = tx[ "description" ] || "[No description]"
                });
                $( '.history' ).innerHTML = '';
                $( '.history' ).append( div );
                $$( '.clickable_tx' ).forEach( item => {
                    item.onclick = () => {
                        var parent = item.parentElement;
                        var txid = parent.getAttribute( "data-txid" );
                        var hidable = parent.getElementsByClassName( "hidable_tx_data" )[ 0 ];
                        if ( !hidable.classList.contains( "hidden" ) ) {
                            brick_wallet.state.history[ txid ][ "detail_hidden" ] = true;
                            hidable.classList.add( "hidden" );
                        } else {
                            brick_wallet.state.history[ txid ][ "detail_hidden" ] = false;
                            hidable.classList.remove( "hidden" );
                        }
                    }
                });
            }
        }
    </script>
    <script>
        var send = async ( invoice, skip_conf ) => {
            var conf = true;
            if ( !invoice ) return;
            if ( !skip_conf ) {
                try {
                    var amount = bolt11.decode( invoice ).satoshis;
                } catch ( e ) {
                    return alert( `your attempt to send money failed for an unknown reason, please try again` );
                }
                var html = `
                    <p>Are you sure you want to send ${amount} sats? It could be more due to routing fees. 1-2% routing fees are common.</p>
                    <p><button class="yes_send" onclick="sessionStorage[ 'yes_send' ] = true;sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Yes</button> <button onclick="sessionStorage[ 'modal_cleared' ] = true;modalVanish();">No</button></p>
                `;
                sessionStorage.removeItem( "yes_send" );
                sessionStorage.removeItem( "modal_cleared" );
                var block_til_clear = true;
                showModal( html, block_til_clear );
                await getNote( "modal_cleared" );
                sessionStorage.removeItem( "modal_cleared" );
                var conf = false;
                if ( sessionStorage[ "yes_send" ] === "true" ) conf = true;
                sessionStorage.removeItem( "yes_send" );
            }
            if ( !conf ) return;
            var amnt = null;
            $( '.invoice_box' ).innerText = invoice;
            showModal( `<p>sending...</p>` );
            nwcjs.tryToPayInvoice( brick_wallet.state.nwc_info, invoice, amnt );
            await brick_wallet.waitSomeTime( 2000 );
            var loop = async () => {
                var delay_tolerance = 10;
                var status = await nwcjs.checkInvoice( brick_wallet.state.nwc_info, invoice, delay_tolerance );
                if ( "error" in status && status[ "error" ] && "message" in status[ "error" ] && status[ "error" ][ "message" ] ) {
                    var err_msg = status[ "error" ][ "message" ];
                    if ( err_msg === "invoice not found" ) err_msg = "Your payment was not sent due to an unknown error, please try again.";
                    return showModal( `<p>${err_msg}</p>` );
                }
                if ( "result" in status && status[ "result" ] && "settled_at" in status[ "result" ] && status[ "result" ][ "settled_at" ] ) {
                    var new_tx = status[ "result" ];
                    if ( new_tx[ "invoice" ] ) var payment_hash = brick_wallet.getInvoicePmthash( new_tx[ "invoice" ] );
                    else var payment_hash = brick_wallet.getInvoicePmthash( new_tx[ "bolt11" ] );
                    var new_txs = {}
                    new_tx[ "detail_hidden" ] = true;
                    new_tx[ "payment_hash" ] = payment_hash;
                    new_txs[ new_tx[ "payment_hash" ] ] = new_tx;
                    brick_wallet.state.history = { ...new_txs, ...brick_wallet.state.history };
                    brick_wallet.parseHistory();
                    balance.calculateBalance();
                    showPage( 'wallet_body' );
                    if ( $( '.modal' ).classList.contains( "hidden" ) ) return;
                    showModal( "<p>paid</p>" );
                    await brick_wallet.waitSomeTime( 1000 );
                    if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                    return;
                }
                await brick_wallet.waitSomeTime( 2000 );
                return await loop();
            }
            loop();
        }
        var showPage = page => {
            $( '.wallet_body' ).classList.add( "hidden" );
            $( '.send_page' ).classList.add( "hidden" );
            $( '.receive_page' ).classList.add( "hidden" );
            $( '.open_send_scanner' ).classList.add( "hidden" );
            $( '.close_send_scanner' ).classList.remove( "hidden" );
            $( '.open_receive_scanner' ).classList.remove( "hidden" );
            $( '.close_receive_scanner' ).classList.add( "hidden" );
            $( '.receive_amnt' ).value = "";
            $( `.${page}` ).classList.remove( "hidden" );
        }
        $( '.submit_receive_form' ).onclick = async () => {
            var amnt = $( '.receive_amnt' ).value;
            if ( !amnt ) return;
            if ( isNaN( amnt ) && !( String( amnt ).startsWith( "lnurl" ) || String( amnt ).startsWith( "LNURL" ) ) ) return alert( `this method of receiving is not supported by this wallet, please try again with a number or an lnurl withdraw code` );
            if ( String( amnt ).startsWith( "lnurl" ) || String( amnt ).startsWith( "LNURL" ) ) {
                var decodedText = String( amnt );
                var url = brick_wallet.hexToText( nwcjs.bytesToHex( bech32.bech32.fromWords( bech32.bech32.decode( decodedText, 100_000 ).words ) ) );
                showModal( `<p>processing...</p>` );
                var data = await fetch( url );
                data = await data.json();
                var tag = data[ "tag" ];
                if ( tag !== "payRequest" && tag !== "withdrawRequest" ) {
                    if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                    return alert( `this type of lnurl is not supported by this wallet` );
                }
                var conf = true;
                if ( tag === "payRequest" ) conf = confirm( `That is an lnurl "paycode," meaning you will "send" money, not receive it. Click ok if that is what you want, otherwise click cancel` );
                if ( !conf ) {
                    if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                    return;
                }
                return handleLNURLdata( data );
            }
            receive( amnt );
        }
        var scan = () => {
            showPage( 'send_page' );
            var html5QrCode = new Html5Qrcode( "send_scanner" );
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 300, height: 300 } },
                async ( decodedText, decodedResult ) => {
                    html5QrCode
                        .stop()
                        .then( res => {
                            html5QrCode.clear();
                        });
                    $( '.open_send_scanner' ).classList.remove( "hidden" );
                    $( '.close_send_scanner' ).classList.add( "hidden" );
                    if ( decodedText.startsWith( "lightning:" ) || decodedText.startsWith( "LIGHTNING:" ) ) decodedText = decodedText.substring( 10 );
                    if ( decodedText.startsWith( "lnurl" ) || decodedText.startsWith( "LNURL" ) ) {
                        var url = brick_wallet.hexToText( nwcjs.bytesToHex( bech32.bech32.fromWords( bech32.bech32.decode( decodedText, 100_000 ).words ) ) );
                        showModal( '<p>processing...</p>' );
                        var data = await fetch( url );
                        data = await data.json();
                        var tag = data[ "tag" ];
                        if ( tag !== "payRequest" && tag !== "withdrawRequest" ) {
                            if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                            return alert( `this type of lnurl is not supported by this wallet` );
                        }
                        var conf = true;
                        if ( tag === "withdrawRequest" ) conf = confirm( `That is an lnurl "withdraw code," meaning you will "receive" money, not send it. Click ok if that is what you want, otherwise click cancel` );
                        if ( !conf ) {
                            if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                            return;
                        }
                        return handleLNURLdata( data );
                    }
                    if ( !decodedText.startsWith( "lnbc" ) && !decodedText.startsWith( "LNBC" ) ) return alert( `your invoice was invalid, try again` );
                    send( decodedText );
                }
            );
            $( '.cancel_send_scanner' ).onclick = () => {
                showPage( 'wallet_body' );
                try {
                    html5QrCode
                        .stop()
                        .then( res => {
                            html5QrCode.clear();
                        });
                } catch ( e ) {}
            }
            $( '.close_send_scanner' ).onclick = () => {
                $( '.open_send_scanner' ).classList.remove( "hidden" );
                $( '.close_send_scanner' ).classList.add( "hidden" );
                html5QrCode
                    .stop()
                    .then( res => {
                        html5QrCode.clear();
                    });
            }
            $( '.open_send_scanner' ).onclick = () => {scan();}
            $( '.paste_invoice' ).onclick = async () => {
                try {
                    html5QrCode
                        .stop()
                        .then( res => {
                            html5QrCode.clear();
                        });
                    $( '.open_send_scanner' ).classList.remove( "hidden" );
                    $( '.close_send_scanner' ).classList.add( "hidden" );
                } catch ( e ) {}
                await brick_wallet.waitSomeTime( 10 );
                var html = `
                    <p>Enter the invoice you want to pay</p>
                    <p><input class="ln_invoice_form"></p>
                    <p><button class="submit_ln_invoice_form" onclick="sessionStorage[ 'ln_invoice' ] = $( '.ln_invoice_form' ).value;sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Submit</button></p>
                `;
                sessionStorage.removeItem( "ln_invoice" );
                sessionStorage.removeItem( "modal_cleared" );
                var block_til_clear = true;
                showModal( html, block_til_clear );
                await getNote( "modal_cleared" );
                sessionStorage.removeItem( "modal_cleared" );
                var invoice = sessionStorage[ "ln_invoice" ];
                sessionStorage.removeItem( "ln_invoice" );
                if ( !invoice ) return;
                if ( invoice.startsWith( "lnurl" ) || invoice.startsWith( "LNURL" ) ) {
                    var url = brick_wallet.hexToText( nwcjs.bytesToHex( bech32.bech32.fromWords( bech32.bech32.decode( invoice, 100_000 ).words ) ) );
                    showModal( '<p>processing...</p>' );
                    var data = await fetch( url );
                    data = await data.json();
                    var tag = data[ "tag" ];
                    if ( tag !== "payRequest" && tag !== "withdrawRequest" ) {
                        if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                        return alert( `this type of lnurl is not supported by this wallet` );
                    }
                    var conf = true;
                    if ( tag === "withdrawRequest" ) conf = confirm( `That is an lnurl "withdraw code," meaning you will "receive" money, not send it. Click ok if that is what you want, otherwise click cancel` );
                    if ( !conf ) {
                        if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                        return;
                    }
                    return handleLNURLdata( data );
                }
                send( invoice );
                showPage( 'wallet_body' );
            }
            $( '.enter_ln_address' ).onclick = async () => {
                try {
                    html5QrCode
                        .stop()
                        .then( res => {
                            html5QrCode.clear();
                        });
                    $( '.open_send_scanner' ).classList.remove( "hidden" );
                    $( '.close_send_scanner' ).classList.add( "hidden" );
                } catch ( e ) {}
                var html = `
                    <p>Enter a lightning address</p>
                    <p><input class="ln_addy_form"></p>
                    <p>Enter how many sats to send there</p>
                    <p><input class="ln_addy_amnt"></p>
                    <p><button class="submit_ln_addy_form" onclick="sessionStorage[ 'ln_addy' ] = $( '.ln_addy_form' ).value;sessionStorage[ 'ln_addy_amnt' ] = $( '.ln_addy_amnt' ).value;sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Submit</button></p>
                `;
                sessionStorage.removeItem( "ln_addy" );
                sessionStorage.removeItem( "ln_addy_amnt" );
                sessionStorage.removeItem( "modal_cleared" );
                var block_til_clear = true;
                showModal( html, block_til_clear );
                await getNote( "modal_cleared" );
                sessionStorage.removeItem( "modal_cleared" );
                var lnaddy = sessionStorage[ "ln_addy" ];
                var amount = Number( sessionStorage[ "ln_addy_amnt" ] );
                sessionStorage.removeItem( "ln_addy" );
                sessionStorage.removeItem( "ln_addy_amnt" );
                if ( !lnaddy || !amount ) return;
                showPage( 'wallet_body' );
                showModal( `<p>sending...</p>` );
                var relays = [ "wss://nostrue.com" ];
                var [ invoice ] = await nwcjs.getZapRequest( lnaddy, amount, relays );
                var skip_conf = true;
                send( invoice, skip_conf );
            }
        }
        $( '.send' ).onclick = () => {scan()};
        var receive = async amnt => {
            if ( !amnt ) {
                $( '.invoice_box' ).innerText = "";
                return;
            }
            showModal( `<p>loading...</p>` );
            var desc = "NWC Wallet";
            var delay_tolerance = 10;
            var invoice_info = await nwcjs.makeInvoice( brick_wallet.state.nwc_info, amnt, desc, delay_tolerance );
            if ( "result_type" in invoice_info && invoice_info[ "result_type" ] !== "make_invoice" ) return alert( `your wallet encountered an undefined error while creating your invoice, try again` );
            if ( "error" in invoice_info && invoice_info[ "error" ] ) return alert( `error creating your invoice: ${JSON.stringify( invoice_info[ "error" ] )} -- please try again` );
            var invoice = invoice_info.result.invoice;
            $( '.invoice_box' ).innerText = invoice;
            var url = "lightning:" + invoice;
            var a = document.createElement( "a" );
            a.href = url;
            a.target = "_blank";
            a.append( createQR( invoice.toUpperCase() ) );
            var prep_div = document.createElement( "div" );
            prep_div.append( a );
            var div_html = prep_div.innerHTML;
            showModal( `<div style="max-width: 15rem; margin: auto;">${div_html}<div class="copy_box"><input class="copy_addy noselect" value="${invoice}" disabled=""><span>&nbsp;</span><div class="copy_btn">âŽ˜</div></div></div>` );
            $( '.copy_btn' ).onclick = () => {
                var copytext = $( '.copy_addy' );
                copytext.select();
                copytext.setSelectionRange( 0, 99999 );
                navigator.clipboard.writeText( copytext.value );
                showToast( 'copied' );
            }
            var loop = async () => {
                await brick_wallet.waitSomeTime( 3000 );
                var delay_tolerance = 10;
                var status_info = await nwcjs.checkInvoice( brick_wallet.state.nwc_info, invoice, delay_tolerance );
                if ( "error" in status_info && status_info[ "error" ] ) return alert( `error checking your invoice status: ${JSON.stringify( status_info[ "error" ] )} -- please refresh your page` );
                if ( !status_info.result.settled_at ) return loop();
                var new_tx = status_info[ "result" ];
                if ( new_tx[ "invoice" ] ) var payment_hash = brick_wallet.getInvoicePmthash( new_tx[ "invoice" ] );
                else var payment_hash = brick_wallet.getInvoicePmthash( new_tx[ "bolt11" ] );
                var new_txs = {}
                new_tx[ "detail_hidden" ] = true;
                new_tx[ "payment_hash" ] = payment_hash;
                new_txs[ new_tx[ "payment_hash" ] ] = new_tx;
                brick_wallet.state.history = { ...new_txs, ...brick_wallet.state.history };
                brick_wallet.parseHistory();
                balance.calculateBalance();
                showPage( 'wallet_body' );
                if ( $( '.modal' ).classList.contains( "hidden" ) ) return;
                showModal( "<p>paid</p>" );
                await brick_wallet.waitSomeTime( 1000 );
                if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                return true;
            }
            var paid = await loop();
        }
        $( '.receive' ).onclick = async () => {showPage( 'receive_page' );}
        $( '.cancel_receive' ).onclick = () => {
            showPage( 'wallet_body' );
        }
        $( '.open_receive_scanner' ).onclick = async () => {
            $( '.open_receive_scanner' ).classList.add( "hidden" );
            $( '.close_receive_scanner' ).classList.remove( "hidden" );
            var html5QrCode = new Html5Qrcode( "receive_scanner" );
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 300, height: 300 } },
                async ( decodedText, decodedResult ) => {
                    html5QrCode
                        .stop()
                        .then( res => {
                            html5QrCode.clear();
                        });
                    $( '.open_receive_scanner' ).classList.remove( "hidden" );
                    $( '.close_receive_scanner' ).classList.add( "hidden" );
                    var conf = true;
                    if ( decodedText.startsWith( "lightning:" ) || decodedText.startsWith( "LIGHTNING:" ) ) {
                        decodedText = decodedText.substring( 10 );
                        if ( !decodedText.startsWith( "lnbc" ) && !decodedText.startsWith( "LNBC" ) && !decodedText.startsWith( "lnurl" ) && !decodedText.startsWith( "LNURL" ) ) return alert( `your invoice was invalid, try again` );
                        var skip = false;
                        if ( decodedText.startsWith( "lnurl" ) || decodedText.startsWith( "LNURL" ) ) skip = true;
                        if ( !skip ) {
                            conf = confirm( `That is a lightning invoice, meaning you will "send" money, not receive it. Click ok if that is what you want, otherwise click cancel` );
                            if ( !conf ) return;
                            send( decodedText );
                        }
                    }
                    if ( decodedText.startsWith( "lnurl" ) || decodedText.startsWith( "LNURL" ) ) {
                        var url = brick_wallet.hexToText( nwcjs.bytesToHex( bech32.bech32.fromWords( bech32.bech32.decode( decodedText, 100_000 ).words ) ) );
                        showModal( '<p>processing...</p>' );
                        var data = await fetch( url );
                        data = await data.json();
                        var tag = data[ "tag" ];
                        if ( tag !== "payRequest" && tag !== "withdrawRequest" ) {
                            if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                            return alert( `this type of lnurl is not supported by this wallet` );
                        }
                        var conf = true;
                        if ( tag === "payRequest" ) conf = confirm( `That is an lnurl "paycode," meaning you will "send" money, not receive it. Click ok if that is what you want, otherwise click cancel` );
                        if ( !conf ) {
                            if ( !$( '.modal' ).classList.contains( "hidden" ) ) $( '.x_modal' ).click();
                            return;
                        }
                        return handleLNURLdata( data );
                    }
                }
            );
            $( '.cancel_receive' ).onclick = () => {
                showPage( 'wallet_body' );
                try {
                    html5QrCode
                        .stop()
                        .then( res => {
                            html5QrCode.clear();
                        });
                } catch ( e ) {}
            }
            $( '.close_receive_scanner' ).onclick = () => {
                $( '.open_receive_scanner' ).classList.remove( "hidden" );
                $( '.close_receive_scanner' ).classList.add( "hidden" );
                html5QrCode
                    .stop()
                    .then( res => {
                        html5QrCode.clear();
                    });
            }
        }
        $( '.disconnect' ).onclick = () => {
            var conf = confirm( `Are you sure you want to disconnect this wallet?` );
            if ( !conf ) return;
            localStorage.removeItem( "brick_wallet_state" );
            stop_the_save = true;
        }

        var balance = {
            html: async () => {
                var sats = balance.bal;
                var bal_to_show = sats;
                var currency = balance.currencies[ balance.currency ];
                if ( currency !== "sats" && currency !== "btc" && currency !== "usd" && !( currency in balance.forex ) ) {
                    var rate = await balance.getTicker( currency.toUpperCase() );
                    balance.forex[ currency ] = rate;
                }
                if ( currency === "usd" ) {
                    bal_to_show = balance.satsToDollars( balance.bal );
                    bal_to_show = bal_to_show.toFixed( 2 );
                    bal_to_show = Number( bal_to_show ).toLocaleString();
                }
                if ( currency === "btc" ) {
                    bal_to_show = balance.satsToBitcoin( balance.bal );
                }
                if ( currency !== "sats" && currency !== "btc" && currency !== "usd" ) {
                    bal_to_show = balance.satsToDollars( balance.bal );
                    var USDMXN = balance.forex[ currency ];
                    bal_to_show = USDMXN * bal_to_show;
                }
                if ( currency === "sats" ) bal_to_show = Number( bal_to_show ).toLocaleString();
                $$( '.tx_amt' ).forEach( tx_amt => {
                    var bal_for_tx_amt = Number( tx_amt.getAttribute( "data-sats" ) );
                    if ( currency === "usd" ) {
                        bal_for_tx_amt = balance.satsToDollars( bal_for_tx_amt );
                        bal_for_tx_amt = bal_for_tx_amt.toFixed( 2 );
                        bal_for_tx_amt = Number( bal_for_tx_amt ).toLocaleString();
                    }
                    if ( currency === "btc" ) {
                        bal_for_tx_amt = balance.satsToBitcoin( bal_for_tx_amt );
                    }
                    if ( currency !== "sats" && currency !== "btc" && currency !== "usd" ) {
                        bal_for_tx_amt = balance.satsToDollars( bal_for_tx_amt );
                        var USDMXN = balance.forex[ currency ];
                        bal_for_tx_amt = USDMXN * bal_for_tx_amt;
                        bal_for_tx_amt = bal_for_tx_amt.toFixed( 2 );
                    }
                    if ( currency === "sats" ) bal_for_tx_amt = Number( bal_for_tx_amt ).toLocaleString();
                    tx_amt.innerText = bal_for_tx_amt + ` ${currency}`
                });
                return `
                    <span class="noselect" data-sats_sum="${sats}">${bal_to_show} ${currency}</span>
                `;
            },
            bal: 0,
            currency: 0,
            currencies: [
                "sats",
                "btc",
                "usd",
            ],
            supported_currencies: [
                "eur",
                "gbp",
                "cad",
                "cny",
                "jpy",
                "inr",
                "rub",
                "mxn",
            ],
            forex: {},
            forex_loaded: false,
            price: 0,
            onlongtouch: null,
            longtouchtimer: null,
            touchduration: 800,
            switchCurrency: () => {
                balance.setState(() => balance.currency = ( balance.currency + 1 ) % balance.currencies.length );
            },
            getPrice: async () => {
                balance.price = await getBitcoinPrice();
                await brick_wallet.waitSomeTime( 15_000 );
                balance.getPrice();
            },
            getTicker: async ticker => {
                var url = `https://assets.ino.com/data/quote/?format=json&s=FOREX_USD${ticker}`;
                var data = await fetch( url );
                var json = await data.json();
                return Number( json[ `FOREX_USD${ticker}` ][ "last" ] );
            },
            satsToDollars: sats => {
                if ( sats >= 100000000 ) sats = sats * 10;
                var value_in_dollars = Number( String( sats ).padStart( 8, "0" ).slice( 0,-9 ) + "." + String( sats ).padStart( 8, "0" ).slice( -9 ) ) * balance.price;
                return value_in_dollars;
            },
            satsToBitcoin: sats => {
                var btc = String( sats ).padStart( 8, "0" ).slice( 0,-8 ) + "." + String( sats ).padStart( 8, "0" ).slice( -8 );
                if ( btc.endsWith( "00000" ) ) {
                    btc = btc.substring( 0, btc.length - 5 );
                    var i; for ( i=0; i<5; i++ ) {
                        if ( btc.endsWith( "0" ) ) btc = btc.substring( 0, btc.length - 1 );
                    }
                    if ( btc.endsWith( "." ) ) btc = btc.substring( 0, btc.length - 1 );
                    if ( !btc ) btc = 0;
                }
                return btc;
            },
            setState: (callback) => {
                callback();
                balance.render();
            },
            calculateBalance: () => {
                balance.setState(() => {
                    var sum = 0;
                    Object.keys( brick_wallet.state.history ).forEach( txid => {
                        var tx = brick_wallet.state.history[ txid ];
                        if ( tx.type === "incoming" ) sum = sum + tx[ "amount" ];
                        else sum = sum - ( tx[ "amount" ] + tx[ "fees_paid" ] );
                    });
                    balance.bal = Math.floor( sum / 1000 );
                });
            },
            addCurrency: item => {
                item.onclick = () => {
                    var btn = document.createElement( "button" );
                    btn.innerText = item.innerText;
                    btn.addEventListener( "click", ()=>{balance.removeCurrency( btn );});
                    btn.click();
                    $( '.selected_currencies' ).append( btn );
                    item.remove();
                }
            },
            removeCurrency: item => {
                item.onclick = () => {
                    var btn = document.createElement( "button" );
                    btn.innerText = item.innerText;
                    btn.addEventListener( "click", ()=>{balance.addCurrency( btn );});
                    btn.click();
                    $( '.supported_currencies' ).append( btn );
                    item.remove();
                }
            },
            modCurrencies: async () => {
                var selected_currencies = [];
                $$( '.selected_currencies button' ).forEach( item => {selected_currencies.push( item.innerText );});
                var supported_currencies = [];
                $$( '.supported_currencies button' ).forEach( item => {supported_currencies.push( item.innerText );});
                balance.currencies = selected_currencies;
                balance.supported_currencies = supported_currencies;
                balance.currency = 0;
                balance.render();
                if ( "selected_currencies" in brick_wallet.state ) brick_wallet.state[ "selected_currencies" ] = [];
                if ( "supported_currencies" in brick_wallet.state ) brick_wallet.state[ "supported_currencies" ] = [];
                brick_wallet.state[ "selected_currencies" ] = selected_currencies;
                brick_wallet.state[ "supported_currencies" ] = supported_currencies;
                var i; for ( i=0; i<balance.currencies.length; i++ ) {
                    var currency = balance.currencies[ i ];
                    if ( currency !== "sats" && currency !== "btc" && currency !== "usd" && !( currency in balance.forex ) ) {
                        var rate = await balance.getTicker( currency.toUpperCase() );
                        // console.log( `got rate for ${currency}: 1 usd = ${rate} ${currency}` );
                        balance.forex[ currency ] = rate;
                        await brick_wallet.waitSomeTime( 2000 );
                    }
                }
            },
            render: async () => {
                $( '.balance' ).innerHTML = await balance.html();
                $( '.balance' ).onpointerdown = function() {
                    balance.onlongtouch = async () => {
                        balance.longtouchtimer = null;
                        var html = `
                            <p>Add/remove currencies</p>
                            <p class="selected_currencies"></p>
                            <p>Quick-tapping the price will toggle through the above currencies in order. Add currencies by tapping them in the list below; remove them by tapping them in the list above.</p>
                            <p class="supported_currencies"></p>
                            <p><button class="submit_currencies_form" onclick="balance.modCurrencies();sessionStorage[ 'modal_cleared' ] = true;modalVanish();">Submit</button></p>
                        `;
                        sessionStorage.removeItem( "modal_cleared" );
                        var block_til_clear = true;
                        showModal( html, block_til_clear );
                        balance.currencies.forEach( item => {
                            var btn = document.createElement( "button" );
                            btn.innerText = item;
                            btn.addEventListener( "click", ()=>{balance.removeCurrency( btn );});
                            btn.click();
                            $( '.selected_currencies' ).append( btn );
                        });
                        balance.supported_currencies.forEach( item => {
                            var btn = document.createElement( "button" );
                            btn.innerText = item;
                            btn.addEventListener( "click", ()=>{balance.addCurrency( btn );});
                            btn.click();
                            $( '.supported_currencies' ).append( btn );
                        });
                        await getNote( "modal_cleared" );
                        sessionStorage.removeItem( "modal_cleared" );
                    };
                    if ( !balance.longtouchtimer || ( !isNaN( balance.longtouchtimer ) && balance.longtouchtimer != null ) ) {
                        balance.longtouchtimer = setTimeout( balance.onlongtouch, balance.touchduration );
                    }
                }
                $( '.balance' ).onpointerup = function( e ) {
                    if ( balance.longtouchtimer ) clearTimeout( balance.longtouchtimer );
                    if ( balance.longtouchtimer ) balance.switchCurrency();
                }
            }
        };

        //Local storage and initialization

        if ( localStorage[ "brick_wallet_state" ] ) brick_wallet.state = JSON.parse( localStorage[ "brick_wallet_state" ] );
        var walletSaver = async () => {
            if ( stop_the_save ) {
                window.location.reload();
                return;
            } else {
                localStorage[ "brick_wallet_state" ] = JSON.stringify( brick_wallet.state );
                await brick_wallet.waitSomeTime( 1000 );
            }
            walletSaver();
        }
        walletSaver();
        brick_wallet.state.offset = 0;
        if ( "selected_currencies" in brick_wallet.state && brick_wallet.state.selected_currencies.length ) balance.currencies = brick_wallet.state.selected_currencies;
        if ( "supported_currencies" in brick_wallet.state && brick_wallet.state.supported_currencies.length ) balance.supported_currencies = brick_wallet.state.supported_currencies;
        Object.keys( brick_wallet.state.history ).forEach( txid => {
            var tx = brick_wallet.state.history[ txid ];
            if ( !tx[ "detail_hidden" ] ) tx[ "detail_hidden" ] = true;
        });
        balance.getPrice();
        window.onload = () => {brick_wallet.init();}
    </script>
    <div class="black-bg hidden"></div>
    <div class="modal hidden"></div>
    <div class="toast"></div>
</body>
</html>
